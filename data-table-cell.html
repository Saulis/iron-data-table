<dom-module id="data-table-cell">
  <template>
    <style is="custom-style">
      :host {
        flex: 1 0 100px;
        padding: 0 24px 0 24px;
        min-height: 10px; /* Prevent iron-list from looping when item height is really small */
        height: 48px;
        display: flex;
        align-items: center;
        overflow: hidden;
        transition: flex-basis 200ms, flex-grow 200ms;
      }

      :host([header]) {
        height: 56px;
      }

      :host([hidden]) {
        display: none;
      }
    </style>
    <content></content>
  </template>
  <script>
    Polymer({
      is: 'data-table-cell',
      behaviors: [Polymer.Templatizer],

      properties: {
        bind: Object,
        order: Number,
        header: Boolean,
        width: String,
        flex: Number,

        index: Number,
        item: Object,
        selected: Boolean,
        expanded: Boolean,

        column: {
          type: Object,
          observer: '_columnChanged2'
        },

        beforeBind: {
          type: Object,
          value: function() {
            return function(data, cell) {};
          }
        },

        template: Object,

        _instance: {
          type: Object,
          computed: '_templatize(column, template)'
        },

        _templatizer: Object
      },

      observers: ['_bindData(_instance, bind)',
                  '_columnChanged(_instance, column)',
                  '_columnPathChanged(_instance, column.*)',
                  '_expandedChanged(_instance, expanded)',
                  '_indexChanged(instance, index)',
                  '_itemChanged(_instance, item)',
                  '_itemPathChanged(_instance, item.*)',
                  '_selectedChanged(_instance, selected)'],

      created: function() {
        this._instanceProps = {
          column: true,
          expanded: true,
          index: true,
          item: true,
          selected: true
        };
      },

      attached: function() {
        if (!Polymer.Settings.useNativeShadow) {
          // cell is supposed to be placed outside the local dom of iron-data-table.
          Polymer.StyleTransformer.dom(this, 'iron-data-table', this._scopeCssViaAttr, true);
          if (this.domHost) {
            Polymer.StyleTransformer.dom(this, this.domHost.tagName.toLowerCase(), this._scopeCssViaAttr, false);
          }
        }

        // in some cases the _columnChanged observer is run before the cell has
        // been turned into a html element and the inline styles don't get applied.
        // Applying them after attaching fixes makes sure they're applied.
        this._setColumnStyleProperties(this.column);

        // TODO: for some reason this needs to be done async to work with Shadow
        // DOM. Left the sync call there also to prevent flickering with Shady DOM.
        this.async(function() {
          this._setColumnStyleProperties(this.column);
        });
      },

      _setColumnStyleProperties: function(column) {
        this.style.flexGrow = column.flex;
        this.style.flexDirection = column.alignRight ? 'row-reverse' : 'row';
        this.style.flexBasis = column.width;
        this.style.flexGrow = column.flex;
      },

      _orderChanged: function(e) {
        this.style.order = e.detail.value;
      },

      _widthChanged: function(e) {
        this.style.flexBasis = e.detail.value;
      },

      _flexChanged: function(e) {
        this.style.flexGrow = e.detail.value;
      },

      _hiddenChanged: function(e) {
        this.hidden = e.detail.value;
      },

      _templatizeRowChanged: function(e) {
        if (!this.header) {
          this._templatizer = e.detail.value;
        }
      },

      _templatizeHeaderChanged: function(e) {
        if (this.header) {
          this._templatizer = e.detail.value;
        }
      },

      _templatize: function(column, template) {
        this.templatize(template);
        var instance = this.stamp({});

        Polymer.dom(this).insertBefore(instance.root, Polymer.dom(this).firstElementChild);

        return instance;
      },

      _bindData: function(instance, data) {
        if (!this.header) {
          this.beforeBind(data, this);
        }
        instance.bind(data);
      },

      _columnChanged: function(instance, column) {
        instance.column = column;
      },

      _columnPathChanged: function(instance, column) {
        instance.notifyPath(column.path, column.value);
      },

      _expandedChanged: function(instance, expanded) {
        // store original expanded value to detect when value change has
        // originated from within the template.
        this._expanded = expanded;

        instance.expanded = expanded;
      },

      _indexChanged: function(instance, index) {
        instance.index = index;
      },

      _itemChanged: function(instance, item) {
        instance.item = item;
      },

      _itemPathChanged: function(instance, item) {
        instance.notifyPath(item.path, item.value);
      },

      _selectedChanged: function(instance, selected) {
        // store original selected value to detect when value change has
        // originated from within the template.
        this._selected = selected;

        instance.selected = selected;
      },

      // TODO: try if declarative listeners work now?
      _columnChanged2: function(column, oldColumn) {
        this._setColumnStyleProperties(column);

        this._addListener(column, oldColumn, 'width');
        this._addListener(column, oldColumn, 'flex');
        this._addListener(column, oldColumn, 'order');

        this.hidden = column.hidden;
        this._addListener(column, oldColumn, 'hidden');

        if (this.header && column.templatizeHeader) {
          this._templatizer = column.templatizeHeader;
        } else if (column.templatizeRow) {
          this._templatizer = column.templatizeRow;
        }
        this._addListener(column, oldColumn, 'templatizeRow');
        this._addListener(column, oldColumn, 'templatizeHeader');
      },

      // Adding listeners manually *seems* to work better with forwarded parent props
      // than normal data-binding. Something to do with notifying the paths correctly.
      _addListener: function(column, oldColumn, prop) {
        var eventName = Polymer.CaseMap.camelToDashCase(prop) + '-changed';
        var observerName = '_' + prop + 'Changed';

        if (oldColumn) {
          this.unlisten(oldColumn, eventName);
        }

        this.listen(column, eventName, observerName);
      },

      /** Templatizer */

      _forwardInstanceProp: function(inst, prop, value) {
        if (prop === 'expanded' && inst.item && this._expanded !== value) {
          if (value) {
            this.column.table.expandItem(inst.item);
          } else {
            this.column.table.collapseItem(inst.item);
          }
        }

        if (prop === 'selected' && inst.item && this._selected !== value) {
          if (value) {
            this.column.table.selectItem(inst.item);
          } else {
            this.column.table.deselectItem(inst.item);
          }
        }
      },

      _forwardInstancePath: function(inst, path, value) {
        // prevent propagating column specific values to other columns.
        // if (path.indexOf('column') === 0) {
        //   return;
        // }
        // var table = Polymer.dom(this).parentNode;
        // var columns = table.columns;
        //
        // for (var c = 0; c < columns.length; c++) {
        //   var instances = columns[c]._templateInstances;
        //
        //   for (var i = 0; i < instances.length; i++) {
        //     var instance = instances[i];
        //     if (instance.index == inst.index) {
        //       instance.notifyPath(path, value);
        //     }
        //   }
        // }

        if (path.indexOf('column') === 0) {
          console.log('todo');
        }

        if (path.indexOf('item') === 0) {
          // instance.notifyPath above will call _forwardInstancePath recursively,
          // so need to debounce to avoid firing the same event multiple times.
          this.column.table.debounce('item-changed', function() {
            // stripping 'item.' from path.
            this.column.table.fire('item-changed', {item: inst.item, path: path.substring(5), value: value});
          }.bind(this));
        }
      }
    });
  </script>
</dom-module>
