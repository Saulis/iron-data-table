<dom-module id="data-table-row">
  <template>
    <style is="custom-style">
      :host {
        display: flex;
        flex-direction: column;
        opacity: 1;
        cursor: pointer;

        @apply(--iron-data-table-row);
      }

      :host([selected]) .cells {
        @apply(--iron-data-table-row-selected);
      }

      :host(:not([header]):hover) {
        @apply(--iron-data-table-row-hover);
      }

      :host(:not([header])[even]) {
        @apply(--iron-data-table-row-even);
      }

      :host(:not([header]):not([even])) {
        @apply(--iron-data-table-row-odd);
      }

      .cells {
        display: flex;
        flex-direction: row;
      }
    </style>
    <div class="cells">
      <content select="data-table-checkbox"></content>
      <content select="data-table-cell"></content>
    </div>
    <div class="details">
      <content select="data-table-row-detail"></content>
    </div>
  </template>
  <script>
    Polymer({
      is: 'data-table-row',

      listeners: {
        'tap': '_onTap'
      },

      properties: {
        expandDetails: {
          type: Boolean,
          notify: true,
          value: false,
          reflectToAttribute: true
        },

        rowDetailTemplate: Object,

        _static: {
          type: Object,
          value: { id: 0 }
        }
      },

      attached: function() {
        if (this.domHost && this.domHost.tagName === 'IRON-DATA-TABLE') {
          var id = this._static.id++;

          var item = this.parentElement;
          if (!item._rowId) {
            this._contentElement = document.createElement('content');
            this._contentElement.setAttribute('select', '#item' + id);
            Polymer.dom(item).appendChild(this._contentElement);
            this.id = 'item' + id;
            item._rowId = id;

            Polymer.dom(this.domHost).appendChild(this);
          }
        }
      },

      _onTap: function(e) {
        var path = Polymer.dom(e).path;

        if (path) {
          if (path[0].tagName === 'INPUT') {
            e.stopPropagation();
            return;
          }
          var i;
          for (i = 0; i < path.length; i++) {
            if (path[i] === this) {
              break;
            }
            if (path[i].getAttribute && path[i].getAttribute('ignore-row-tap') !== null) {
              e.stopPropagation();
              return;
            }
          }
        }

        //TODO: event should be fired only when template exists
        var expandEvent = this.fire('iron-data-table-row-expanding', { row: this, target: e.target }, { bubbles: true, cancelable: true });
        if (this.rowDetailTemplate && !expandEvent.defaultPrevented) {
          this.expandDetails = !this.expandDetails;
        }

        //TODO: event should be fired only when selection is enabled
        var selectEvent = this.fire('iron-data-table-row-selecting', { row: this, target: e.target }, { bubbles: true, cancelable: true });
        if (selectEvent.defaultPrevented) {
          e.stopPropagation();
        }
      }
    });
  </script>
</dom-module>
